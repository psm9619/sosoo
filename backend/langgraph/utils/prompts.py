"""
Claude í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿

ë¶„ì„, ê°œì„ ì•ˆ ìƒì„±, Reflection ë“±ì— ì‚¬ìš©ë˜ëŠ” í”„ë¡¬í”„íŠ¸ë¥¼ ì •ì˜í•©ë‹ˆë‹¤.
í”„ë¡¬í”„íŠ¸ ì—”ì§€ë‹ˆì–´ë§ì˜ í•µì‹¬ ìš”ì†Œë“¤ì„ í¬í•¨í•©ë‹ˆë‹¤.
"""

from typing import Optional, List, Dict, Any


# ============================================
# ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸
# ============================================

ANALYSIS_SYSTEM_PROMPT = """ë‹¹ì‹ ì€ 10ë…„ ê²½ë ¥ì˜ ì „ë¬¸ ìŠ¤í”¼ì¹˜ ì½”ì¹˜ì…ë‹ˆë‹¤.
ë©´ì ‘, ë°œí‘œ, í”„ë ˆì  í…Œì´ì…˜ ì½”ì¹­ ì „ë¬¸ê°€ë¡œì„œ ìˆ˜ì²œ ëª…ì„ ì½”ì¹­í•œ ê²½í—˜ì´ ìˆìŠµë‹ˆë‹¤.

## ë¶„ì„ ì›ì¹™

1. **ê°ê´€ì  ë°ì´í„° ê¸°ë°˜**: ëŠë‚Œë³´ë‹¤ ìˆ˜ì¹˜ë¡œ íŒë‹¨í•©ë‹ˆë‹¤
2. **ì‹¤ìš©ì  ì¡°ì–¸**: ë°”ë¡œ ì ìš©í•  ìˆ˜ ìˆëŠ” êµ¬ì²´ì ì¸ íŒì„ ì œê³µí•©ë‹ˆë‹¤
3. **ê¸ì •ì  í†¤**: ë¹„íŒë³´ë‹¤ ë°œì „ ê°€ëŠ¥ì„±ì— ì´ˆì ì„ ë§ì¶¥ë‹ˆë‹¤
4. **ìš°ì„ ìˆœìœ„**: ê°€ì¥ íš¨ê³¼ì ì¸ 1-2ê°€ì§€ ê°œì„ ì ì— ì§‘ì¤‘í•©ë‹ˆë‹¤

## í‰ê°€ ê¸°ì¤€

- ë…¼ë¦¬/êµ¬ì¡°: STAR êµ¬ì¡° ì¤€ìˆ˜, ë‘ê´„ì‹ í‘œí˜„
- í•„ëŸ¬ì›Œë“œ: ì „ì²´ì˜ 4% ì´í•˜ê°€ ì´ìƒì 
- ë§ ì†ë„: 120-170 WPMì´ ì´ìƒì 
- ìì‹ ê°: ì–´ì¡°ì˜ í™•ì‹ , ë¶ˆí•„ìš”í•œ ê²¸ì–‘ íšŒí”¼
- êµ¬ì²´ì„±: ìˆ«ì, ì‚¬ë¡€, êµ¬ì²´ì  ê²°ê³¼ í¬í•¨

## ì ìˆ˜ ì²´ê³„

A: íƒì›”í•¨ (ê±°ì˜ ìˆ˜ì • ë¶ˆí•„ìš”)
B+: ì¢‹ìŒ (ë¯¸ì„¸ ì¡°ì •ë§Œ í•„ìš”)
B: ì–‘í˜¸ (ëª‡ ê°€ì§€ ê°œì„ ì  ìˆìŒ)
C+: ë³´í†µ (ëª…í™•í•œ ê°œì„ ì  ìˆìŒ)
C: ê°œì„  í•„ìš” (ì—¬ëŸ¬ ë¬¸ì œì  ìˆìŒ)
D: ë§ì€ ê°œì„  í•„ìš”"""


IMPROVEMENT_SYSTEM_PROMPT = """ë‹¹ì‹ ì€ ìŠ¤í”¼ì¹˜ ì‘ê°€ì…ë‹ˆë‹¤.
ì›ë³¸ì˜ ê°œì„±ê³¼ ë©”ì‹œì§€ë¥¼ ì‚´ë¦¬ë©´ì„œ, ì „ë‹¬ë ¥ì„ ë†’ì´ëŠ” ê²ƒì´ ëª©í‘œì…ë‹ˆë‹¤.

## ê°œì„  ì›ì¹™

1. **ë©”ì‹œì§€ ë³´ì¡´**: ì›ë³¸ì´ ë§í•˜ê³ ì í•˜ëŠ” í•µì‹¬ì€ ì ˆëŒ€ ë³€ê²½í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤
2. **ë§íˆ¬ ìœ ì§€**: í™”ìì˜ ì–´íœ˜, í‘œí˜„ ìŠ¤íƒ€ì¼ì„ ìµœëŒ€í•œ ìœ ì§€í•©ë‹ˆë‹¤
3. **ìì—°ìŠ¤ëŸ¬ì›€**: ì‹¤ì œë¡œ ë”°ë¼ ë§í•  ìˆ˜ ìˆëŠ” ìì—°ìŠ¤ëŸ¬ìš´ ë¬¸ì¥ì„ ì”ë‹ˆë‹¤
4. **ìµœì†Œ ê°œì…**: ë¬¸ì œê°€ ìˆëŠ” ë¶€ë¶„ë§Œ ìˆ˜ì •í•˜ê³ , ì˜ëœ ë¶€ë¶„ì€ ê·¸ëŒ€ë¡œ ë‘¡ë‹ˆë‹¤

## ê¸ˆì§€ ì‚¬í•­

- ì›ë³¸ì— ì—†ëŠ” ë‚´ìš© ì¶”ê°€í•˜ì§€ ì•Šê¸°
- ë„ˆë¬´ êµê³¼ì„œì /ê²©ì‹ì²´ë¡œ ë°”ê¾¸ì§€ ì•Šê¸°
- ì „ë¬¸ ìš©ì–´ë‚˜ ì–´ë ¤ìš´ í‘œí˜„ ë„£ì§€ ì•Šê¸°
- ì›ë³¸ë³´ë‹¤ ì§€ë‚˜ì¹˜ê²Œ ê¸¸ì–´ì§€ì§€ ì•Šê¸°

## ì¶œë ¥ í˜•ì‹

ê°œì„ ëœ ìŠ¤í¬ë¦½íŠ¸ë§Œ ì¶œë ¥í•˜ì„¸ìš”. ì„¤ëª…ì´ë‚˜ ì„œë‘ëŠ” ë„£ì§€ ë§ˆì„¸ìš”."""


REFLECTION_SYSTEM_PROMPT = """ë‹¹ì‹ ì€ ìŠ¤í”¼ì¹˜ ì½”ì¹­ í’ˆì§ˆ ê²€í† ìì…ë‹ˆë‹¤.
ê°œì„ ì•ˆì´ ì›ë³¸ì˜ ì˜ë„ë¥¼ ì˜ ì‚´ë ¸ëŠ”ì§€, ì‹¤ì œë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ”ì§€ ê²€í† í•©ë‹ˆë‹¤.

## ê²€í†  ê¸°ì¤€

1. **ë©”ì‹œì§€ ë³´ì¡´**: ì›ë³¸ì˜ í•µì‹¬ ë©”ì‹œì§€ê°€ ìœ ì§€ë˜ì—ˆëŠ”ê°€?
2. **ê°œì„  ë°˜ì˜**: ë¶„ì„ì—ì„œ ì§€ì í•œ ë¬¸ì œì ì´ ì‹¤ì œë¡œ ê°œì„ ë˜ì—ˆëŠ”ê°€?
3. **ê°œì„± ìœ ì§€**: ì›ë³¸ì˜ ë§íˆ¬/ìŠ¤íƒ€ì¼ì´ ë„ˆë¬´ ë§ì´ ë°”ë€Œì§€ ì•Šì•˜ëŠ”ê°€?
4. **ìì—°ìŠ¤ëŸ¬ì›€**: ì‹¤ì œë¡œ ë”°ë¼ ë§í•  ìˆ˜ ìˆëŠ” ìì—°ìŠ¤ëŸ¬ìš´ ë¬¸ì¥ì¸ê°€?

## ì¶œë ¥ í˜•ì‹ (JSON)

{
    "passes_review": true/false,
    "issues_found": ["ë¬¸ì œì 1", "ë¬¸ì œì 2"],
    "suggested_fixes": ["ìˆ˜ì •ì‚¬í•­1"],
    "final_script": "ìˆ˜ì •ëœ ìµœì¢… ìŠ¤í¬ë¦½íŠ¸ (ë¬¸ì œ ì—†ìœ¼ë©´ ë¹ˆ ë¬¸ìì—´)"
}"""


# ============================================
# í”„ë¡¬í”„íŠ¸ ë¹Œë” í•¨ìˆ˜
# ============================================

def build_analysis_prompt(
    transcript: str,
    pace_data: dict,
    filler_data: dict,
    structure_data: dict = None,
    user_patterns: dict = None,
    previous_sessions: List[dict] = None,
    memory_prompt: str = None,  # ğŸ†• Memory í”„ë¡¬í”„íŠ¸ ì¶”ê°€
) -> str:
    """
    ë¶„ì„ í”„ë¡¬í”„íŠ¸ êµ¬ì„±
    
    ë„êµ¬ì—ì„œ ìˆ˜ì§‘í•œ ê°ê´€ì  ë°ì´í„°ì™€ Progressive Context,
    ê·¸ë¦¬ê³  Memory ì‹œìŠ¤í…œì˜ ê°œì¸í™” ì •ë³´ë¥¼ í¬í•¨í•©ë‹ˆë‹¤.
    
    Args:
        transcript: ë¶„ì„í•  í…ìŠ¤íŠ¸
        pace_data: ë§ ì†ë„ ë¶„ì„ ê²°ê³¼
        filler_data: í•„ëŸ¬ì›Œë“œ ë¶„ì„ ê²°ê³¼
        structure_data: STAR êµ¬ì¡° ë¶„ì„ ê²°ê³¼
        user_patterns: Progressive Context íŒ¨í„´
        previous_sessions: ì´ì „ ì„¸ì…˜ ê¸°ë¡
        memory_prompt: Memory ì‹œìŠ¤í…œì—ì„œ ìƒì„±ëœ í”„ë¡¬í”„íŠ¸ (LTM + STM)
    """
    
    prompt_parts = []
    
    # 0. Memory í”„ë¡¬í”„íŠ¸ (ìˆìœ¼ë©´ ìµœìƒë‹¨ì— ë°°ì¹˜)
    if memory_prompt:
        prompt_parts.append(memory_prompt)
        prompt_parts.append("")  # ë¹ˆ ì¤„
    
    # 1. ì›ë³¸ í…ìŠ¤íŠ¸
    prompt_parts.append(f"""## ë¶„ì„í•  ë‹µë³€

{transcript}""")
    
    # 2. ê°ê´€ì  ì¸¡ì • ë°ì´í„°
    prompt_parts.append(f"""
## ì¸¡ì • ë°ì´í„° (ë„êµ¬ ë¶„ì„ ê²°ê³¼)

### ë§ ì†ë„
- WPM: {pace_data.get('words_per_minute', 'N/A')}
- í‰ê°€: {pace_data.get('assessment', 'N/A')}
- ëª©í‘œ ë²”ìœ„: {pace_data.get('target_range', '120-170 WPM')}

### í•„ëŸ¬ì›Œë“œ
- ê°œìˆ˜: {filler_data.get('filler_count', 0)}ê°œ
- ë¹„ìœ¨: {filler_data.get('filler_percentage', 0)}%
- í‰ê°€: {filler_data.get('assessment', 'N/A')}""")
    
    # 3. STAR êµ¬ì¡° ë°ì´í„° (ìˆìœ¼ë©´)
    if structure_data:
        elements = structure_data.get('elements_found', {})
        prompt_parts.append(f"""
### STAR êµ¬ì¡°
- Situation: {'âœ“' if elements.get('situation') else 'âœ—'}
- Task: {'âœ“' if elements.get('task') else 'âœ—'}
- Action: {'âœ“' if elements.get('action') else 'âœ—'}
- Result: {'âœ“' if elements.get('result') else 'âœ—'}
- ìˆ«ì í¬í•¨: {'ì˜ˆ' if structure_data.get('has_numbers') else 'ì•„ë‹ˆì˜¤'}""")
    
    # 4. Progressive Context (ìˆìœ¼ë©´)
    if user_patterns and not user_patterns.get('is_new_user'):
        prompt_parts.append(f"""
## ìœ ì € íˆìŠ¤í† ë¦¬ (Progressive Context)

- ì„¸ì…˜ íšŸìˆ˜: {user_patterns.get('session_count', 0)}íšŒ
- ë°˜ë³µ ë¬¸ì œì : {', '.join(user_patterns.get('recurring_issues', [])) or 'ì—†ìŒ'}
- ê°œì„  ì¶”ì„¸: {user_patterns.get('improvement_trend', 'unknown')}

ì´ ìœ ì €ì—ê²ŒëŠ” ìœ„ ë°˜ë³µ íŒ¨í„´ì— ëŒ€í•œ ì§„ì „ ì—¬ë¶€ë¥¼ í™•ì¸í•˜ê³ , 
ê²©ë ¤í•˜ê±°ë‚˜ ì¶”ê°€ ì¡°ì–¸ì„ í•´ì£¼ì„¸ìš”.""")
    
    # 5. ë¶„ì„ ìš”ì²­
    prompt_parts.append("""
## ìš”ì²­ì‚¬í•­

ìœ„ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì¢…í•© ë¶„ì„ì„ ìˆ˜í–‰í•˜ê³ , ë‹¤ìŒ JSON í˜•ì‹ìœ¼ë¡œ ì‘ë‹µí•´ì£¼ì„¸ìš”:

{
    "scores": {
        "logic_structure": "A/B+/B/C+/C/D",
        "filler_words": "...",
        "speaking_pace": "...",
        "confidence_tone": "...",
        "content_specificity": "..."
    },
    "suggestions": [
        {"priority": 1, "category": "ì¹´í…Œê³ ë¦¬", "suggestion": "ì œì•ˆ", "impact": "íš¨ê³¼"}
    ],
    "structure_analysis": "STAR êµ¬ì¡° ë¶„ì„ ì„¤ëª…",
    "progressive_note": "ì´ì „ ì„¸ì…˜ ëŒ€ë¹„ ë³€í™” (í•´ë‹¹ë˜ëŠ” ê²½ìš°)"
}""")
    
    return "\n".join(prompt_parts)


def build_improvement_prompt(
    transcript: str,
    analysis: dict,
    question: Optional[str] = None,
    memory_prompt: str = None,  # ğŸ†• Memory í”„ë¡¬í”„íŠ¸ ì¶”ê°€
) -> str:
    """
    ê°œì„ ì•ˆ ìƒì„± í”„ë¡¬í”„íŠ¸ êµ¬ì„±
    
    Args:
        transcript: ì›ë³¸ í…ìŠ¤íŠ¸
        analysis: ë¶„ì„ ê²°ê³¼
        question: ë©´ì ‘ ì§ˆë¬¸ (ìˆìœ¼ë©´)
        memory_prompt: Memory ì‹œìŠ¤í…œì—ì„œ ìƒì„±ëœ í”„ë¡¬í”„íŠ¸ (LTM + STM)
    """
    
    prompt_parts = []
    
    # 0. Memory í”„ë¡¬í”„íŠ¸ (ìˆìœ¼ë©´ ìµœìƒë‹¨ì— ë°°ì¹˜)
    if memory_prompt:
        prompt_parts.append(memory_prompt)
        prompt_parts.append("")  # ë¹ˆ ì¤„
    
    # 1. ì§ˆë¬¸ (ìˆìœ¼ë©´)
    if question:
        prompt_parts.append(f"## ë©´ì ‘ ì§ˆë¬¸\n{question}\n")
    
    # 2. ì›ë³¸ ë‹µë³€
    prompt_parts.append(f"""## ì›ë³¸ ë‹µë³€

{transcript}""")
    
    # 3. ë¶„ì„ ê²°ê³¼ ìš”ì•½
    suggestions = analysis.get('suggestions', [])
    if suggestions:
        suggestion_text = "\n".join(
            f"- [{s.get('category', '')}] {s.get('suggestion', '')}"
            for s in suggestions[:3]  # ìƒìœ„ 3ê°œë§Œ
        )
        prompt_parts.append(f"""
## ë¶„ì„ì—ì„œ ë°œê²¬ëœ ê°œì„ ì 

{suggestion_text}""")
    
    # 4. ê°œì„  ìš”ì²­
    prompt_parts.append("""
## ìš”ì²­ì‚¬í•­

ìœ„ ë¶„ì„ ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ ê°œì„ ëœ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”.

ì£¼ì˜ì‚¬í•­:
1. ì›ë³¸ì˜ í•µì‹¬ ë©”ì‹œì§€ì™€ ë§íˆ¬ë¥¼ ìœ ì§€í•˜ì„¸ìš”
2. ìœ„ì—ì„œ ì§€ì í•œ ë¬¸ì œì ë§Œ ê°œì„ í•˜ì„¸ìš”
3. ì‹¤ì œë¡œ ë”°ë¼ ë§í•  ìˆ˜ ìˆëŠ” ìì—°ìŠ¤ëŸ¬ìš´ ë¬¸ì¥ì„ ì“°ì„¸ìš”
4. ì„¤ëª… ì—†ì´ ê°œì„ ëœ ìŠ¤í¬ë¦½íŠ¸ë§Œ ì¶œë ¥í•˜ì„¸ìš”""")
    
    return "\n".join(prompt_parts)


def build_reflection_prompt(
    original: str,
    draft: str,
    analysis: dict,
) -> str:
    """Reflection í”„ë¡¬í”„íŠ¸ êµ¬ì„±"""
    
    return f"""## ì›ë³¸ ë‹µë³€

{original}

## ìƒì„±ëœ ê°œì„ ì•ˆ

{draft}

## ì›ë˜ ë¶„ì„ì—ì„œ ì§€ì í•œ ë¬¸ì œì 

{_format_suggestions(analysis.get('suggestions', []))}

## ê²€í†  ìš”ì²­

ìœ„ ê°œì„ ì•ˆì´ ë‹¤ìŒ ê¸°ì¤€ì„ ì¶©ì¡±í•˜ëŠ”ì§€ ê²€í† í•˜ê³ , JSONìœ¼ë¡œ ì‘ë‹µí•´ì£¼ì„¸ìš”:

1. ì›ë³¸ì˜ í•µì‹¬ ë©”ì‹œì§€ê°€ ìœ ì§€ë˜ì—ˆëŠ”ê°€?
2. ë¶„ì„ì—ì„œ ì§€ì í•œ ë¬¸ì œì ì´ ì‹¤ì œë¡œ ê°œì„ ë˜ì—ˆëŠ”ê°€?
3. ì›ë³¸ì˜ ë§íˆ¬/ìŠ¤íƒ€ì¼ì´ ë„ˆë¬´ ë§ì´ ë°”ë€Œì§€ ì•Šì•˜ëŠ”ê°€?
4. ì‹¤ì œë¡œ ë”°ë¼ ë§í•  ìˆ˜ ìˆëŠ” ìì—°ìŠ¤ëŸ¬ìš´ ë¬¸ì¥ì¸ê°€?

{{
    "passes_review": true/false,
    "issues_found": ["ë°œê²¬ëœ ë¬¸ì œì "],
    "suggested_fixes": ["ê¶Œì¥ ìˆ˜ì •ì‚¬í•­"],
    "final_script": "ìˆ˜ì •ëœ ìŠ¤í¬ë¦½íŠ¸ (ë¬¸ì œ ì—†ìœ¼ë©´ ë¹ˆ ë¬¸ìì—´)"
}}"""


def _format_suggestions(suggestions: List[dict]) -> str:
    """ê°œì„  ì œì•ˆ í¬ë§·íŒ…"""
    if not suggestions:
        return "ì—†ìŒ"
    
    return "\n".join(
        f"- {s.get('suggestion', '')}"
        for s in suggestions[:5]
    )